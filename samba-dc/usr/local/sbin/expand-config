#!/bin/bash

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

set -e

REALM=${REALM:?}
IPADDRESS=${IPADDRESS:?}
HOSTNAME=${HOSTNAME:?}
NBDOMAIN=${NBDOMAIN:?}

cat - > /etc/krb5.conf <<EOF
# generated by $0
[libdefaults]
        default_realm = ${REALM^^}
        dns_lookup_realm = false
        dns_lookup_kdc = true

[realms]
${REALM^^} = {
        default_domain = ${REALM,,}
}

[domain_realm]
        ${REALM,,} = ${REALM^^}
EOF

cat - > /etc/hosts <<EOF
127.0.0.1     localhost.localdomain localhost
${IPADDRESS}     ${HOSTNAME} ${HOSTNAME%%.*}
EOF

cat - > /etc/resolv.conf <<EOF
search ${REALM,,}
nameserver ${DNS1ADDRESS:-${IPADDRESS}}
EOF
# Secondary DNS resolver for member role
if [[ -n "${DNS1ADDRESS}" ]] && [[ -n "${DNS2ADDRESS}" ]] ; then
    echo "nameserver = ${DNS2ADDRESS}" >> /etc/resolv.conf
fi

nbname=$(hostname -s)
mkdir -vp "/var/lib/samba/sysvol/${REALM,,}/scripts"
cat - >/etc/samba/smb.conf <<EOF
# Generated by expand-config. Manual changes to this file are lost!
[homes]
comment = %u home directory
browseable = no
writeable = yes

EOF

cat - >>/etc/samba/smb.conf <<EOF
[global]
        ${PREFIXLEN:+disable netbios = Yes}
        bind interfaces only = Yes
        interfaces = 127.0.0.1 ${IPADDRESS}${PREFIXLEN:+/}${PREFIXLEN}
        netbios name = ${nbname^^}
        netbios aliases = ${NBALIAS}
        realm = ${REALM^^}
        workgroup = ${NBDOMAIN}
        log level = ${SAMBA_LOGLEVEL:-1}
        acl_xattr:security_acl_name = user.NTACL
        acl_xattr:ignore system acls = yes
        template homedir = ${SAMBA_HOMES_DIR:?}/%U
        obey pam restrictions = yes
        registry shares = yes
        inherit owner = yes
        full_audit:prefix = %R|%I|%u|%S
        full_audit:facility = LOCAL7
        full_audit:priority = INFO
        full_audit:success = none
        full_audit:failure = none
        recycle:repository =
        recycle:keeptree = yes
        recycle:versions = yes

EOF

if [[ "${SERVER_ROLE}" == "member" ]] ; then
cat - >>/etc/samba/smb.conf <<ROLEMEMBER
        vfs objects = acl_xattr recycle full_audit
        winbind use default domain = yes
        idmap config * : backend = tdb
        idmap config * : range = 1001-1999
        idmap config ${NBDOMAIN} : backend = rid
        idmap config ${NBDOMAIN} : range = 2000-65500
        # Note: Add idmap ranges for trusted domains to include.conf
        #       Check /proc/self/uid_map and uid of nobody for range
        #       upper bound
        server role = member server
        include = /etc/samba/include.conf

ROLEMEMBER
else
cat - >>/etc/samba/smb.conf <<ROLEDC
        vfs objects = dfs_samba4 acl_xattr recycle full_audit
        server role = active directory domain controller
        include = /etc/samba/include.conf

[sysvol]
        path = /var/lib/samba/sysvol
        read only = No
        acl_xattr:ignore system acls = no
        inherit owner = no
[netlogon]
        path = /var/lib/samba/sysvol/${REALM,,}/scripts
        read only = No

ROLEDC
fi
